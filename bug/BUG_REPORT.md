# Bug Report: php-to-ts-generator v1.3.0

## Issue Summary
The `generateWithDependencies()` method is not automatically generating nested class dependencies, and PHPDoc array type annotations in constructor parameters are not being parsed correctly.

## Environment
- **Package**: `igorbabkin/php-to-ts-generator` v1.3.0
- **PHP Version**: 8.1+
- **Expected Behavior**: Automatic nested dependency generation and PHPDoc array type parsing

## Test Case 1: Missing Nested Dependencies

### PHP Source Code
```php
<?php

namespace LMS\EV\View\Tariff;

use LMS\EV\Entity\ProviderProfile;
use LMS\EV\Entity\RoamingNetwork;
use LMS\EV\Entity\TariffMarginsItem;

class TariffEditMarginViewContextDTO
{
    /**
     * @param array<ProviderProfile> $providersList
     * @param array<RoamingNetwork> $roamingNetworks
     * @param array<string>|null $paymentTypes
     * @param array<string, string> $allPaymentOptions
     */
    public function __construct(
        public readonly array $providersList,
        public readonly array $roamingNetworks,
        public readonly ?TariffMarginsItem $editingMargin,
        public readonly ?ProviderProfile $provider,
        public readonly ?string $success,
        public readonly ?string $errorMessage,
        public readonly string $nonce,
        public readonly bool $isTariffBased,
        public readonly string $providerRole,
        public readonly string $recipient,
        public readonly string $marginPaidBy,
        public readonly string $priceType,
        public readonly ?int $roamingNetworkId,
        public readonly bool $applyMarginsNoCosts,
        public readonly string $costType,
        public readonly ?int $additionalProviderProfileId,
        public readonly ?array $paymentTypes,
        public readonly float $kwhMargin,
        public readonly float $startMargin,
        public readonly float $minuteMargin,
        public readonly float $idleFeeMargin,
        public readonly array $allPaymentOptions,
    ) {
    }
}
```

### Expected TypeScript Output
```typescript
import { TariffMarginsItem } from './TariffMarginsItem';
import { ProviderProfile } from './ProviderProfile';
import { RoamingNetwork } from './RoamingNetwork';

export interface TariffEditMarginViewContextDTO {
  providersList: ProviderProfile[];
  roamingNetworks: RoamingNetwork[];
  editingMargin: TariffMarginsItem | null;
  provider: ProviderProfile | null;
  success: string | null;
  errorMessage: string | null;
  nonce: string;
  isTariffBased: boolean;
  providerRole: string;
  recipient: string;
  marginPaidBy: string;
  priceType: string;
  roamingNetworkId: number | null;
  applyMarginsNoCosts: boolean;
  costType: string;
  additionalProviderProfileId: number | null;
  paymentTypes: string[] | null;
  kwhMargin: number;
  startMargin: number;
  minuteMargin: number;
  idleFeeMargin: number;
  allPaymentOptions: Record<string, string>;
}
```

### Actual TypeScript Output
```typescript
import { TariffMarginsItem } from './TariffMarginsItem';
import { ProviderProfile } from './ProviderProfile';

export interface TariffEditMarginViewContextDTO {
  providersList: any[];  // ❌ Should be ProviderProfile[]
  roamingNetworks: any[];  // ❌ Should be RoamingNetwork[]
  editingMargin: TariffMarginsItem | null;
  provider: ProviderProfile | null;
  success: string | null;
  errorMessage: string | null;
  nonce: string;
  isTariffBased: boolean;
  providerRole: string;
  recipient: string;
  marginPaidBy: string;
  priceType: string;
  roamingNetworkId: number | null;
  applyMarginsNoCosts: boolean;
  costType: string;
  additionalProviderProfileId: number | null;
  paymentTypes: any[] | null;  // ❌ Should be string[] | null
  kwhMargin: number;
  startMargin: number;
  minuteMargin: number;
  idleFeeMargin: number;
  allPaymentOptions: any[];  // ❌ Should be Record<string, string>
}
```

## Test Case 2: Missing Nested Class Generation

### Problem
When calling `$generator->generateWithDependencies(TariffEditMarginViewContextDTO::class)`, the method should automatically generate:
- `TariffMarginsItem.ts`
- `ProviderProfile.ts` 
- `RoamingNetwork.ts`

But it only generates the main DTO file.

### Expected Behavior
According to the v1.1.0 changelog:
> **BREAKING**: Nested class dependencies are now generated by default (previously required `--with-dependencies` flag)
> CLI now automatically creates separate TypeScript files for all nested classes

### Actual Behavior
Only the main class is generated, nested dependencies are ignored.

## Test Case 3: PHPDoc Array Type Parsing

### PHP Code with PHPDoc
```php
/**
 * @param array<ProviderProfile> $providersList
 * @param array<RoamingNetwork> $roamingNetworks  
 * @param array<string>|null $paymentTypes
 * @param array<string, string> $allPaymentOptions
 */
public function __construct(
    public readonly array $providersList,
    public readonly array $roamingNetworks,
    public readonly ?array $paymentTypes,
    public readonly array $allPaymentOptions,
) {}
```

### Expected TypeScript
```typescript
providersList: ProviderProfile[];
roamingNetworks: RoamingNetwork[];
paymentTypes: string[] | null;
allPaymentOptions: Record<string, string>;
```

### Actual TypeScript
```typescript
providersList: any[];
roamingNetworks: any[];
paymentTypes: any[] | null;
allPaymentOptions: any[];
```

## Test Case 4: Working Array Types in Regular Properties

### PHP Code (This works correctly)
```php
class TariffMarginsItem
{
    /**
     * @var array<int, int>|null See Transaction::PAYMENT_* constants
     */
    public ?array $paymentTypes = null;
}
```

### Generated TypeScript (Correct)
```typescript
/**
 * @var array<int, int>|null See Transaction::PAYMENT_* constants
 */
paymentTypes: Record<number, number>;
```

## Root Cause Analysis

1. **Nested Dependencies**: The `generateWithDependencies()` method is not following type references in constructor parameters
2. **PHPDoc Parsing**: Constructor parameter PHPDoc comments are not being parsed for array types
3. **Inconsistency**: Regular property PHPDoc works, but constructor parameter PHPDoc doesn't

## Reproduction Steps

1. Install `igorbabkin/php-to-ts-generator` v1.3.0
2. Create a DTO with constructor parameters that reference other classes
3. Add PHPDoc array type annotations to constructor parameters
4. Call `$generator->generateWithDependencies(YourDTO::class)`
5. Observe that nested classes are not generated and array types are `any[]`

## Expected Fix

1. **Nested Dependencies**: `generateWithDependencies()` should recursively analyze all type references and generate separate files
2. **PHPDoc Parsing**: Constructor parameter PHPDoc should be parsed the same way as regular property PHPDoc
3. **Array Types**: Complex array types like `array<Type>`, `array<Key, Value>` should be converted to proper TypeScript types

## Workaround

Currently, we need to manually add all classes to the generation list:

```php
$sourceClasses = [
    \LMS\EV\View\Tariff\TariffEditMarginViewContextDTO::class,
    \LMS\EV\Entity\TariffMarginsItem::class,
    \LMS\EV\Entity\ProviderProfile::class,
    \LMS\EV\Entity\RoamingNetwork::class,
];
```

This defeats the purpose of automatic dependency resolution.

## Impact

- **High**: Core functionality (automatic dependency generation) is broken
- **Medium**: PHPDoc array type parsing is inconsistent
- **User Experience**: Users must manually track all dependencies instead of relying on automatic resolution
